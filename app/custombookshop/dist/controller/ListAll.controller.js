sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/core/syncStyleClass","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/odata/type/Int","sap/ui/model/type/Integer"],function(e,t,o,i,a,s,n){"use strict";return e.extend("ntt.bookshop.custombookshop.controller.ListAll",{onInit:function(){this.oDataModel=this.getOwnerComponent().getModel();let e=this.getView("ListAll").byId("idTblBookData").getTable();e.setMode("MultiSelect");e.attachSelectionChange(this.onBookTableSelection,this);this._fetchData();this._initialModel()},_initialModel:function(){var e=this.getView();var t={ID:null,title:"",descr:"",author:{ID:null,name:""},author_ID:0,category_ID:0};var o=new a;e.setModel(o,"mainModel");e.getModel("mainModel").setProperty("/createBookData",t);var i={authorName:true};e.getModel("mainModel").setProperty("/booleanControl",i);var s={book_ID:null,bringDate:new Date,person:""};e.getModel("mainModel").setProperty("/LendBookData",s)},_fetchData:function(){var e=this.getView();this.oDataModel.read("/Authors",{success:(t,o)=>{var i=t.results;if(i&&i.length>0){e.getModel("mainModel").setProperty("/Authors",i)}else{e.getModel("mainModel").setProperty("/Authors",[])}},error:e=>{try{var t=JSON.parse(e.responseText);t=t.error.message.value}catch(o){t=e.message}sap.m.MessageBox.alert(t,{icon:sap.m.MessageBox.Icon.ERROR,title:"Error!"})}})},onOpenMultiEdit:function(e){t.load({name:"ntt.bookshop.custombookshop.view.fragments.MultiEditBookDialog",controller:this}).then(function(e){this.oBooksMultiEditDialog=e;this.getView().addDependent(this.oBooksMultiEditDialog);this.oBooksMultiEditDialog.setEscapeHandler(function(){this.onCloseDialog()}.bind(this));this.oBooksMultiEditDialog.getContent()[0].setContexts(this.getView().byId("idTblBookData").getTable().getSelectedContexts());o("sapUiSizeCompact",this.getView(),this.oBooksMultiEditDialog);this.oBooksMultiEditDialog.open()}.bind(this))},onBookCloseDialog:function(){this.oBooksMultiEditDialog.close();this.oBooksMultiEditDialog.destroy();this.oBooksMultiEditDialog=null},onBookTableSelection:function(){var e=this.getView().byId("idTblBookData").getTable().getSelectedItems();this.getView().byId("btnMultiEditBook").setEnabled(e.length>0);this.getView().byId("btnDeleteBook").setEnabled(e.length>0)},onBookDialogSaveButton:function(){var e=this.oBooksMultiEditDialog.getContent()[0];this.oBooksMultiEditDialog.setBusy(true);e.getErroneousFieldsAndTokens().then(function(e){this.oBooksMultiEditDialog.setBusy(false);if(e.length===0){this._saveChanges()}}.bind(this)).catch(function(){this.oBooksMultiEditDialog.setBusy(false)}.bind(this))},_saveChanges:function(){var e=this.oBooksMultiEditDialog.getContent()[0],t=this,o,a,s,n,r;var l=function(e){var t=e.getPropertyName(),o=e.getUnitOfMeasurePropertyName();if(!e.getApplyToEmptyOnly()||!n[t]||typeof n[t]=="string"&&!n[t].trim()){r[t]=s[t]}if(e.isComposite()){if(!e.getApplyToEmptyOnly()||!n[o]){r[o]=s[o]}}};i.show("Save action started");e.getAllUpdatedContexts(true).then(function(e){i.show("Updated contexts available",{onClose:function(){debugger;o=e;for(var d=0;d<o.length;d++){a=o[d].context;s=o[d].data;n=a.getModel().getObject(a.getPath());r={};this._getFields().filter(function(e){return!e.isKeepExistingSelected()}).forEach(l);a.getModel().update(a.getPath(),r)}i.show("Model was updated");t.onBookCloseDialog()}.bind(this)})}.bind(e));this.oBooksMultiEditDialog.close()},onScanSuccess:function(e){var t=e.getParameter("text");var o=this.getView().byId("smartFilterBar");o.clear();var i=o.getFilterData();i.ID={items:[{key:t}],ranges:[],value:null};o.setFilterData(i,true);this.getView().byId("idTblBookData").rebindTable()},onBeforeRebindBooksTable:function(e){},onScanError:function(e){i.show("Scan failed: "+e,{duration:1e3})},onDeleteBook:function(e){var t=this.getView().byId("idTblBookData").getTable().getSelectedItems();this.oDataModel.setDeferredGroups(["group1"]);for(var o=0;o<t.length;o++){var i=t[o].getBindingContext().getPath();this.oDataModel.remove(i,{groupId:"group1",success:function(e,t){debugger},error:function(e){}})}this.oDataModel.submitChanges({groupId:"group1"})},onPressCreateBook:function(e){this.pDialog??=this.loadFragment({name:"ntt.bookshop.custombookshop.view.fragments.CreateBookDialog"});this.pDialog.then(e=>{this.bookDialog=e;e.open()})},onScanSuccessCreate:function(e){var t=e.getParameter("text");this.getView().getModel("mainModel").setProperty("/createBookData/ID",t)},_onCloseBookDialog:function(e){this.bookDialog.close()},_onCreateBook:function(e){var t=this;var o=this.getView().getModel("mainModel");var i=o.getProperty("/createBookData");var a=this.getView().getModel("mainModel").getProperty("/booleanControl/authorName");if(!a){delete i.author}sap.ui.core.BusyIndicator.show(0);this.oDataModel.create("/Books",i,{success:(e,o)=>{sap.ui.core.BusyIndicator.hide(0);t._initialModel();t._fetchData();t.bookDialog.close()},error:e=>{t.bookDialog.close();try{var o=JSON.parse(e.responseText);o=o.error.message.value}catch(t){o=e.message}sap.m.MessageBox.alert(o,{icon:sap.m.MessageBox.Icon.ERROR,title:"Error!"});sap.ui.core.BusyIndicator.hide(0)}})},onAuthorIdInputLiveChange:function(e){var t=this.getView().getModel("mainModel").getProperty("/Authors");var o=parseInt(e.getParameter("value"));var i=t.filter(e=>e.ID===o);if(i.length>0){delete i[0].__metadata;this.getView().getModel("mainModel").setProperty("/createBookData/author",i[0]);this.getView().getModel("mainModel").setProperty("/booleanControl/authorName",false);this.getView().getModel("mainModel").refresh()}else{this.getView().getModel("mainModel").setProperty("/booleanControl/authorName",true);this.getView().getModel("mainModel").setProperty("/createBookData/author/ID",o)}},onPressLendBook:function(e){this.pDialog2??=this.loadFragment({name:"ntt.bookshop.custombookshop.view.fragments.LendBookDialog"});this.pDialog2.then(e=>{this.LendDialog=e;e.open()})},_onLendBook:function(e){var t=this;var o=this.getView().getModel("mainModel");var i=o.getProperty("/LendBookData");debugger;sap.ui.core.BusyIndicator.show(0);this.oDataModel.create("/Reporting",i,{success:(e,o)=>{sap.ui.core.BusyIndicator.hide(0);t._initialModel();t.getView().byId("idTblBookData").rebindTable();t.LendDialog.close()},error:e=>{t.LendDialog.close();try{var o=JSON.parse(e.responseText);o=o.error.message.value}catch(t){o=e.message}sap.m.MessageBox.alert(o,{icon:sap.m.MessageBox.Icon.ERROR,title:"Error!"});sap.ui.core.BusyIndicator.hide(0)}})},_onCloseLendDialog:function(e){this.LendDialog.close()},onScanSuccessLend:function(e){var t=e.getParameter("text");this.getView().getModel("mainModel").setProperty("/LendBookData/book_ID",t)}})});